# SMB (Server Message Block) aka CIFS (Common Internet File System)
# - used for everything not just file and printer sharing
# - very old protocol with several versions and many security vulnerabilities
# - IPC, MSRPC
# - shares Windows authentication systems
# - current version is 3.X
# - SMB ports are generally port numbers 139 and 445.
# - NFS (portmapper, rpcbind)
# - Available via TCP and UDP
# - similar/compatible implementations used by Linux (samba) and MacOS

# NOTICE: all smb interaction requires a NETBIOS name for client
#         which we can specify in smb.conf
#         default is `Kali` which is a bit of a giveaway...

# looking for hostname
$ sudo nmap -Pn --script smb-os-discovery 10.11.1.146
[*] Nmap: Host script results:
[*] Nmap: | smb-os-discovery:
[*] Nmap: |   OS: Windows 6.1 (Samba 4.5.4-Ubuntu)
[*] Nmap: |   Computer name: \x00
[*] Nmap: |   NetBIOS computer name: SUSIE\x00
[*] Nmap: |   Workgroup: WORKGROUP\x00
[*] Nmap: |_  System time: 2021-10-03T12:58:57-04:00

# looking for share names
$ sudo nmap -Pn --script smb-enum-shares -p139,445 10.11.1.146
[*] Nmap: PORT    STATE SERVICE
[*] Nmap: 139/tcp open  netbios-ssn
[*] Nmap: 445/tcp open  microsoft-ds
[*] Nmap: Host script results:
[*] Nmap: | smb-enum-shares:
[*] Nmap: |   account_used: guest
[*] Nmap: |   \\10.11.1.146\IPC$:
[*] Nmap: |     Type: STYPE_IPC_HIDDEN
[*] Nmap: |     Comment: IPC Service (susie server (Samba, Ubuntu))
[*] Nmap: |     Users: 1
[*] Nmap: |     Max Users: <unlimited>
[*] Nmap: |     Path: C:\tmp
[*] Nmap: |     Anonymous access: READ/WRITE
[*] Nmap: |     Current user access: READ/WRITE
[*] Nmap: |   \\10.11.1.146\SusieShare:
[*] Nmap: |     Type: STYPE_DISKTREE
[*] Nmap: |     Comment: YOUR COMMENTS
[*] Nmap: |     Users: 1
[*] Nmap: |     Max Users: <unlimited>
[*] Nmap: |     Path: C:\home\susie\susieshare
[*] Nmap: |     Anonymous access: READ/WRITE
[*] Nmap: |     Current user access: READ/WRITE
[*] Nmap: |   \\10.11.1.146\print$:
[*] Nmap: |     Type: STYPE_DISKTREE
[*] Nmap: |     Comment: Printer Drivers
[*] Nmap: |     Users: 0
[*] Nmap: |     Max Users: <unlimited>
[*] Nmap: |     Path: C:\var\lib\samba\printers
[*] Nmap: |     Anonymous access: <none>
[*] Nmap: |_    Current user access: <none>

# TODO: nmap found IPC$ to be read/write and enumerated `C:\tmp`
#       while the other variations (smbmap) thought it was not accessible. hmm...

# on a windows box
C:\> net view \\192.168.1.17 /All
# with auth
C:\> net use \\server\share /user:domain\username password

# via msf
msf> use auxiliary/scanner/smb/smb_enumshares

# enumerate shares
$ crackmapexec smb 10.11.1.146 -u 'guest' -p '' --shares

# rpcclient
$ rpcclient -U '' -N 10.11.1.146
rpcclient $> netshareenum
netname: SusieShare
	remark:	YOUR COMMENTS
	path:	C:\home\susie\susieshare
	password:	
rpcclient $> netshareenumall
netname: print$
	remark:	Printer Drivers
	path:	C:\var\lib\samba\printers
	password:	
netname: SusieShare
	remark:	YOUR COMMENTS
	path:	C:\home\susie\susieshare
	password:	
netname: IPC$
	remark:	IPC Service (susie server (Samba, Ubuntu))
	path:	C:\tmp
	password:	

# check smb vulnerabilities
# NOTICE: this does not work! must run each script individually...
sudo nmap -Pn --script smb-vuln* 10.11.1.146
[*] Nmap: PORT    STATE SERVICE
[*] Nmap: 22/tcp  open  ssh
[*] Nmap: 139/tcp open  netbios-ssn
[*] Nmap: 445/tcp open  microsoft-ds
[*] Nmap: Host script results:
[*] Nmap: |_smb-vuln-ms10-054: false
[*] Nmap: |_smb-vuln-ms10-061: false
[*] Nmap: | smb-vuln-regsvc-dos:
[*] Nmap: |   VULNERABLE:
[*] Nmap: |   Service regsvc in Microsoft Windows systems vulnerable to denial of service
[*] Nmap: |     State: VULNERABLE
[*] Nmap: |       The service regsvc in Microsoft Windows 2000 systems is vulnerable to denial of service caused by a null deference
[*] Nmap: |       pointer. This script will crash the service if it is vulnerable. This vulnerability was discovered by Ron Bowes
[*] Nmap: |       while working on smb-enum-sessions.
[*] Nmap: |_


# similar enumerators:
#   ie. msf auxiliary/scanner/smb/smb_lookupsid
#       python3 lookupsid.py DOMAIN/username:password@ipv4
#       linux enum4linux

# normal scan using enum4linux. It extracts
# - RID Range
# - Usernames
# - Workgroup
# - Nbtstat Information
# - Sessions
# - SID Information
# - OS Information
# NOTICE: knowing what users exist on a system can greatly speed up any further brute-force logon attempts later on.
$ enum4linux 10.11.1.146
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sun Oct  3 13:14:36 2021

 ========================== 
|    Target Information    |
 ========================== 
Target ........... 10.11.1.146
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 =================================================== 
|    Enumerating Workgroup/Domain on 10.11.1.146    |
 =================================================== 
[E] Can't find workgroup/domain


 =========================================== 
|    Nbtstat Information for 10.11.1.146    |
 =========================================== 
Looking up status of 10.11.1.146
No reply from 10.11.1.146

 ==================================== 
|    Session Check on 10.11.1.146    |
 ==================================== 
[+] Server 10.11.1.146 allows sessions using username '', password ''
[+] Got domain/workgroup name: 

 ========================================== 
|    Getting domain SID for 10.11.1.146    |
 ========================================== 
Domain Name: WORKGROUP
Domain Sid: (NULL SID)

 ===================================== 
|    OS information on 10.11.1.146    |
 ===================================== 
[+] Got OS info for 10.11.1.146 from smbclient: 
[+] Got OS info for 10.11.1.146 from srvinfo:
	SUSIE          Wk Sv PrQ Unx NT SNT susie server (Samba, Ubuntu)
	platform_id     :	500
	os version      :	6.1
	server type     :	0x809a03
...


 ============================================ 
|    Getting printer info for 10.11.1.146    |
 ============================================ 
No printers returned.
enum4linux complete on Sun Oct  3 13:24:37 2021





# TODO: in case we need to brute force
# Password Complexity: Disabled
# Minimum Password Length: 5

# TODO: maybe this will come in handy
# `S-1-22-1-1000 Unix User\susie (Local User)`

# this appears to be a Windows 7 box hosting Samba with unix-style user 1000 susie (WSL?)


# sometimes you can capture the smb version on the wire in plaintext
# while interacting with it in some way (ie. smbclient)
# ie. Unix.Samba.2.2.3a.MYGROUP...
$ sudo tcpdump -ni tun0 -A src 10.11.1.146



# i guess crackmapexec can do more than crack?
# here it enumerates smb version information for me
# this is worth a try even anonymous against a server that normally requires auth, because it's like a banner grab
$ crackmapexec smb 10.11.1.146
SMB         10.11.1.146     445    SUSIE            [*] Windows 6.1 (name:SUSIE) (domain:) (signing:False) (SMBv1:True)
# TODO: learn more about crackmapexec "swiss army knife for pentesting networks"




# identify os
$ smbmap -H 10.11.1.146 -v
[+] 10.11.1.146:445 is running Windows 6.1 Build 0 (name:SUSIE) (domain:SUSIE)

# `Windows 6.1 Build 0`
# both Windows 7 and Windows 6.1 are the same product, it's just 2 ways of referring to it.

# scan everything available on smb to guest
$ smbmap -H 10.11.1.146
[+] Guest session   	IP: 10.11.1.146:445	Name: 10.11.1.146
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	print$                                            	NO ACCESS	Printer Drivers
	SusieShare                                        	READ, WRITE	YOUR COMMENTS
	IPC$                                              	NO ACCESS	IPC Service (susie server (Samba, Ubuntu))

# list root of all shares (non-recursive)
$ smbmap -H 10.11.1.146 -r
[+] Guest session   	IP: 10.11.1.146:445	Name: 10.11.1.146
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	print$                                            	NO ACCESS	Printer Drivers
	SusieShare                                        	READ, WRITE	YOUR COMMENTS
	.\SusieShare\*
	dr--r--r--                0 Sun Oct  3 12:49:05 2021	.
	dr--r--r--                0 Sat Dec 21 02:51:25 2019	..
	fr--r--r--                0 Sat Dec 21 01:40:59 2019	FsSRC.txt
	IPC$                                              	NO ACCESS	IPC Service (susie server (Samba, Ubuntu))

# list root of all shares (recursive)
$ smbmap -H 10.11.1.146 -R





# another way to download files interactively
$ smbclient //10.11.1.146/SusieShare -U guest
Enter WORKGROUP\guest's password: <ENTER>
Try "help" to get a list of possible commands.
smb: \> help
?              allinfo        altname        archive        backup         
blocksize      cancel         case_sensitive cd             chmod          
chown          close          del            deltree        dir            
du             echo           exit           get            getfacl        
geteas         hardlink       help           history        iosize         
lcd            link           lock           lowercase      ls             
l              mask           md             mget           mkdir          
more           mput           newer          notify         open           
posix          posix_encrypt  posix_open     posix_mkdir    posix_rmdir    
posix_unlink   posix_whoami   print          prompt         put            
pwd            q              queue          quit           readlink       
rd             recurse        reget          rename         reput          
rm             rmdir          showacls       setea          setmode        
scopy          stat           symlink        tar            tarmode        
timeout        translate      unlock         volume         vuid           
wdel           logon          listconnect    showconnect    tcon           
tdis           tid            utimes         logoff         ..             
!              
smb: \> ls
  .                                   D        0  Sun Oct  3 12:49:05 2021
  ..                                  D        0  Sat Dec 21 02:51:25 2019
  FsSRC.txt                           A        0  Sat Dec 21 01:40:59 2019

		16446332 blocks of size 1024. 13436112 blocks available
smb: \> 





msf6 > use auxiliary/scanner/smb/smb_version
msf6 auxiliary(scanner/smb/smb_version) > set RHOSTS 10.11.1.146
msf6 auxiliary(scanner/smb/smb_version) > run

[*] 10.11.1.146:445       - SMB Detected (versions:1, 2, 3) (preferred dialect:SMB 3.1.1) (compression capabilities:) (encryption capabilities:AES-128-CCM) (signatures:optional) (guid:{69737573-0065-0000-0000-000000000000}) (authentication domain:SUSIE)
[*] 10.11.1.146:445       -   Host could not be identified: Windows 6.1 (Samba 4.5.4-Ubuntu)
[*] 10.11.1.146:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

# same info that we got from nmap earlier



# download all remote files to local



# BEST! download all files recursively
$ mkdir home; cd home;
$ smbclient //10.11.1.231/home
smb> mask ""
smb> recurse ON
smb> prompt OFF
smb> mget *

# automated
$ mkdir home; cd home; smbclient //10.11.1.231/home '' -c 'recurse on; prompt OFF; mget *'








# short list


# Enumerate Hostname
nmblookup -A [ip]
# List Shares
smbmap -H [ip/hostname]
echo exit | smbclient -L \\\\[ip]
nmap --script smb-enum-shares -p 139,445 [ip]
# Check Null Sessions
smbmap -H [ip/hostname]
rpcclient -U "" -N [ip]
smbclient \\\\[ip]\\[share name]
# Check for Vulnerabilities
nmap --script smb-vuln* -p 139,445 [ip]
# Overall Scan
enum4linux -a [ip]
# Manual Inspection
smbver.sh [IP] (port) [Samba]
check pcap

